<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCG Savings Workshop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: radial-gradient(circle at top left, #F4FBFC 0%, #EEF2F4 60%, #E6ECEE 100%);
            color: #0B3C3E;
            overflow-x: hidden;
        }

        header {
            background: linear-gradient(135deg, #0F6C72, #0B3C3E);
            color: white;
            padding: 52px 24px 44px;
        }

        header h1 {
            margin: 0 0 12px;
            font-size: 36px;
            letter-spacing: -0.02em;
        }

        header p {
            margin: 0;
            max-width: 780px;
            font-size: 16px;
            line-height: 1.6;
            color: rgba(255,255,255,0.85);
        }

        main {
            max-width: 1100px;
            margin: 32px auto 96px;
            padding: 0 24px 160px;
        }

        .dcg-card {
            background: white;
            border-radius: 28px;
            box-shadow: 0 30px 75px rgba(15, 108, 114, 0.16);
            padding: 42px;
            display: grid;
            gap: 44px;
        }

        .dcg-section-title {
            font-size: 20px;
            font-weight: 600;
            color: #0C4A4E;
        }

        .dcg-contact-card {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            background: rgba(15, 108, 114, 0.08);
            border: 1px solid rgba(12, 74, 78, 0.12);
            border-radius: 18px;
            padding: 20px;
        }

        .dcg-contact-chip {
            padding: 12px 18px;
            border-radius: 14px;
            background: white;
            min-width: 180px;
            color: #0B3C3E;
            font-weight: 600;
            display: grid;
            gap: 4px;
            box-shadow: 0 10px 24px rgba(15,108,114,0.12);
        }

        .dcg-contact-chip span {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #4F6F71;
        }

        .dcg-contact-missing {
            background: rgba(244, 67, 54, 0.08);
            border: 1px solid rgba(244, 67, 54, 0.2);
            border-radius: 18px;
            padding: 20px;
            color: #812026;
            font-weight: 500;
        }

        .dcg-lender-builder {
            display: grid;
            gap: 22px;
        }

        .dcg-lender-rows {
            display: grid;
            gap: 18px;
        }

        .dcg-lender-row {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            background: #F9FBFB;
            border: 1px solid rgba(12, 74, 78, 0.12);
            border-radius: 18px;
            padding: 20px;
            position: relative;
        }

        .dcg-lender-field {
            display: grid;
            gap: 8px;
        }

        .dcg-lender-field label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            color: #4F6F71;
        }

        .dcg-input, .dcg-select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(12, 74, 78, 0.2);
            font-size: 15px;
            background: white;
        }

        .dcg-remove-row {
            position: absolute;
            top: 16px;
            right: 16px;
            border: none;
            background: rgba(244, 67, 54, 0.12);
            color: #821E23;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
        }

        .dcg-remove-row:hover {
            background: rgba(244, 67, 54, 0.22);
        }

        .dcg-add-row {
            justify-self: start;
            border: 1px dashed rgba(12, 74, 78, 0.35);
            background: transparent;
            color: #0F6C72;
            border-radius: 14px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: border 0.2s ease, transform 0.2s ease;
        }

        .dcg-add-row:hover {
            border-color: #0F6C72;
            transform: translateY(-1px);
        }

        .dcg-run-panel {
            display: grid;
            gap: 16px;
        }

        .dcg-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .dcg-primary-button {
            padding: 14px 22px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #0F6C72, #0B3C3E);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 16px 30px rgba(15, 108, 114, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dcg-primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 45px rgba(15, 108, 114, 0.25);
        }

        .dcg-secondary-button {
            padding: 14px 22px;
            border-radius: 16px;
            border: 1px solid rgba(12, 74, 78, 0.22);
            background: white;
            color: #0B3C3E;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .dcg-secondary-button[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .dcg-secondary-button:hover:not([disabled]) {
            transform: translateY(-1px);
            border-color: #0F6C72;
        }

        .dcg-status {
            font-size: 13px;
            padding: 12px 16px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            width: fit-content;
        }

        .dcg-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .dcg-status-info {
            background: rgba(15, 108, 114, 0.08);
            color: #0B3C3E;
        }

        .dcg-status-info::before {
            background: #0F6C72;
        }

        .dcg-status-dirty {
            background: rgba(244, 162, 97, 0.16);
            color: #6E3810;
        }

        .dcg-status-dirty::before {
            background: #F08A24;
        }

        .dcg-summary-wrapper {
            display: none;
        }

        .dcg-summary-wrapper.dcg-visible {
            display: block;
            animation: fadeInUp 0.6s ease forwards;
        }

        .dcg-summary {
            background: linear-gradient(135deg, rgba(15, 108, 114, 0.08), rgba(15, 108, 114, 0.02));
            border: 1px solid rgba(12, 74, 78, 0.12);
            border-radius: 24px;
            padding: 28px;
            display: grid;
            gap: 24px;
            position: relative;
            overflow: hidden;
        }

        .dcg-summary-hero {
            display: grid;
            gap: 8px;
            text-align: left;
        }

        .dcg-summary-label {
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.12em;
            color: #0F6C72;
            font-weight: 600;
        }

        .dcg-summary-value {
            font-size: 42px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: #0B3C3E;
        }

        .dcg-summary-sub {
            font-size: 14px;
            color: #4F6F71;
        }

        .dcg-summary-grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .dcg-summary-card {
            background: white;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid rgba(12, 74, 78, 0.08);
            box-shadow: 0 14px 28px rgba(15,108,114,0.08);
            display: grid;
            gap: 6px;
        }

        .dcg-summary-card span {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #4F6F71;
            font-weight: 600;
        }

        .dcg-summary-card strong {
            font-size: 20px;
            color: #0B3C3E;
            font-weight: 700;
        }

        .dcg-qualification {
            padding: 20px;
            border-radius: 18px;
            background: rgba(16, 185, 129, 0.12);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #0B3C3E;
            font-weight: 500;
            line-height: 1.5;
        }

        .dcg-qualification.dcg-warning {
            background: rgba(244, 114, 182, 0.12);
            border-color: rgba(244, 114, 182, 0.32);
            color: #7C2C55;
        }

        .dcg-next-steps {
            background: rgba(11, 60, 62, 0.06);
            border-radius: 18px;
            padding: 22px;
            border: 1px solid rgba(11, 60, 62, 0.1);
        }

        .dcg-next-steps ul {
            margin: 0;
            padding-left: 20px;
            display: grid;
            gap: 8px;
        }

        .dcg-back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            text-decoration: none;
            color: rgba(255,255,255,0.9);
            margin-top: 18px;
        }

        .dcg-chat-toggle {
            position: fixed;
            bottom: 24px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #0F6C72, #0B3C3E);
            color: white;
            font-size: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 16px 32px rgba(15,108,114,0.28);
            z-index: 10001;
            cursor: pointer;
        }

        .dcg-chat-toggle.dcg-open {
            background: linear-gradient(135deg, #0B3C3E, #062325);
        }

        .dcg-confetti-piece {
            position: absolute;
            width: 10px;
            height: 14px;
            top: -20px;
            border-radius: 3px;
            opacity: 0;
            animation: confetti-fall 1.2s ease forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translateY(220px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(18px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (min-width: 1220px) {
            header {
                padding-right: 420px;
            }

            main {
                margin-right: 400px;
            }
        }

        @media (min-width: 1500px) {
            header {
                padding-right: 460px;
            }

            main {
                margin-right: 440px;
            }
        }

        @media (max-width: 960px) {
            .dcg-lender-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .dcg-card {
                padding: 32px;
            }

            header {
                padding: 44px 20px 36px;
            }

            main {
                padding: 0 20px 140px;
                margin: 24px auto 80px;
            }
        }

        @media (max-width: 640px) {
            .dcg-card {
                padding: 24px;
            }

            .dcg-lender-row {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .dcg-summary-value {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <header>
        <a class="dcg-back-link" href="index.html">← Back to Demo Homepage</a>
        <h1>Interactive Savings Workshop</h1>
        <p>Adjust the sample debt profile below, then run the calculator to see how much you could keep in cash flow every month. When you’re ready, tap “I’m interested” and a DCG specialist will follow up.</p>
    </header>

    <main>
        <div class="dcg-card">
            <section>
                <div class="dcg-section-title">Your details</div>
                <div id="dcg-contact-container"></div>
            </section>

            <section class="dcg-lender-builder">
                <div class="dcg-section-title">Debt portfolio</div>
                <p style="margin: 0; color: #4F6F71;">Include every creditor you want DCG to negotiate. Use the notes field to mark MCAs or high-priority accounts.</p>
                <div class="dcg-lender-rows" id="dcg-lender-rows"></div>
                <button type="button" class="dcg-add-row" id="dcg-add-lender">＋ Add another lender</button>

                <div class="dcg-run-panel">
                    <div class="dcg-actions">
                        <button type="button" id="dcg-run-calculation" class="dcg-primary-button">Run savings estimate</button>
                        <button type="button" id="dcg-interest-button" class="dcg-secondary-button" disabled>I'm interested in these savings</button>
                    </div>
                    <div id="dcg-run-status" class="dcg-status dcg-status-info">Adjust the inputs above and run your estimate when you’re ready.</div>
                </div>
            </section>

            <section id="dcg-summary-wrapper" class="dcg-summary-wrapper">
                <div class="dcg-summary" id="dcg-summary">
                    <div class="dcg-summary-hero">
                        <span class="dcg-summary-label">Projected monthly savings</span>
                        <div class="dcg-summary-value" id="dcg-summary-monthly">$0</div>
                        <div class="dcg-summary-sub">versus your current payment schedule</div>
                    </div>
                    <div class="dcg-summary-grid">
                        <div class="dcg-summary-card">
                            <span>Current weekly payments</span>
                            <strong id="dcg-weekly-total">$0</strong>
                        </div>
                        <div class="dcg-summary-card">
                            <span>Recommended weekly payment</span>
                            <strong id="dcg-weekly-target">$0</strong>
                        </div>
                        <div class="dcg-summary-card">
                            <span>Estimated settlement</span>
                            <strong id="dcg-settlement">$0</strong>
                        </div>
                        <div class="dcg-summary-card">
                            <span>Program length</span>
                            <strong id="dcg-program-length">0 months</strong>
                        </div>
                    </div>
                    <div id="dcg-qualification" class="dcg-qualification dcg-warning">Enter at least $25,000 in unsecured debt to check eligibility.</div>
                </div>
            </section>

            <section class="dcg-next-steps">
                <div class="dcg-section-title">What happens after you run the estimate?</div>
                <ul>
                    <li>Review these numbers with a DCG specialist within 24 hours.</li>
                    <li>Gather statements for the lenders you listed so underwriting can finalize the offer.</li>
                    <li>Tap “I’m interested” any time to let us know you want a call about this scenario.</li>
                </ul>
            </section>
        </div>
    </main>

    <iframe
        src="dcg-ally-enhanced.html?mode=sidebar"
        style="position: fixed; bottom: 32px; right: 16px; width: min(420px, 38vw); max-width: 440px; height: min(640px, 92vh); border: none; border-radius: 22px; box-shadow: 0 28px 60px rgba(15,108,114,0.25); z-index: 9999;"
        title="DCG Assistant Sidebar"
        id="dcgAllyFrameSidebar"
        allow="clipboard-write">
    </iframe>

    <button id="dcgChatToggle" class="dcg-chat-toggle" aria-label="Open chat">💬</button>

    <script>
        const compactMedia = window.matchMedia('(max-width: 960px)');
        let isCompact = compactMedia.matches;
        const contactContainer = document.getElementById('dcg-contact-container');
        const sidebarFrame = document.getElementById('dcgAllyFrameSidebar');
        const chatToggle = document.getElementById('dcgChatToggle');

        function applySidebarLayout(compact) {
            if (!sidebarFrame) return;
            if (compact) {
                sidebarFrame.style.width = 'calc(100vw - 32px)';
                sidebarFrame.style.left = '16px';
                sidebarFrame.style.right = '16px';
                sidebarFrame.style.height = 'min(80vh, 560px)';
                sidebarFrame.style.bottom = '24px';
                sidebarFrame.style.borderRadius = '20px';
                sidebarFrame.style.display = 'none';
                if (chatToggle) {
                    chatToggle.style.display = 'flex';
                    chatToggle.classList.remove('dcg-open');
                }
            } else {
                sidebarFrame.style.width = 'min(420px, 38vw)';
                sidebarFrame.style.left = '';
                sidebarFrame.style.right = '16px';
                sidebarFrame.style.height = 'min(640px, 92vh)';
                sidebarFrame.style.bottom = '32px';
                sidebarFrame.style.borderRadius = '22px';
                sidebarFrame.style.display = 'block';
                if (chatToggle) {
                    chatToggle.style.display = 'none';
                    chatToggle.classList.remove('dcg-open');
                }
            }
        }

        applySidebarLayout(isCompact);
        if (compactMedia.addEventListener) {
            compactMedia.addEventListener('change', (event) => {
                isCompact = event.matches;
                applySidebarLayout(isCompact);
            });
        }

        if (chatToggle) {
            chatToggle.addEventListener('click', () => {
                const isVisible = sidebarFrame.style.display === 'block';
                if (isVisible) {
                    sidebarFrame.style.display = 'none';
                    chatToggle.classList.remove('dcg-open');
                } else {
                    sidebarFrame.style.display = 'block';
                    chatToggle.classList.add('dcg-open');
                }
            });
        }
        const lenderRowsEl = document.getElementById('dcg-lender-rows');
        const addRowBtn = document.getElementById('dcg-add-lender');
        const runButton = document.getElementById('dcg-run-calculation');
        const interestButton = document.getElementById('dcg-interest-button');
        const statusEl = document.getElementById('dcg-run-status');
        const summaryWrapper = document.getElementById('dcg-summary-wrapper');
        const summaryCard = document.getElementById('dcg-summary');

        const monthlySavingsEl = document.getElementById('dcg-summary-monthly');
        const weeklyTotalEl = document.getElementById('dcg-weekly-total');
        const weeklyTargetEl = document.getElementById('dcg-weekly-target');
        const settlementEl = document.getElementById('dcg-settlement');
        const programLengthEl = document.getElementById('dcg-program-length');
        const qualificationEl = document.getElementById('dcg-qualification');

        let hasRun = false;
        let isDirty = false;

        const contactPayload = (() => {
            try {
                const raw = sessionStorage.getItem('dcgCalculatorContact');
                return raw ? JSON.parse(raw) : null;
            } catch (error) {
                console.warn('Unable to read contact payload', error);
                return null;
            }
        })();

        if (contactPayload && (contactPayload.name || contactPayload.phone || contactPayload.email)) {
            const name = contactPayload.name || 'Prospect';
            const phone = formatReadablePhone(contactPayload.phone || '');
            const email = contactPayload.email || '—';

            contactContainer.innerHTML = `
                <div class="dcg-contact-card">
                    <div class="dcg-contact-chip">
                        <span>Name</span>
                        ${name}
                    </div>
                    <div class="dcg-contact-chip">
                        <span>Phone</span>
                        ${phone || '—'}
                    </div>
                    <div class="dcg-contact-chip">
                        <span>Email</span>
                        ${email}
                    </div>
                    <div class="dcg-contact-chip">
                        <span>Captured</span>
                        ${new Date(contactPayload.timestamp || Date.now()).toLocaleString()}
                    </div>
                </div>
            `;
        } else {
            contactContainer.innerHTML = `
                <div class="dcg-contact-missing">
                    We don’t have contact info for this session. Jump back to the assistant, share your name, email, and phone, then return to unlock the calculator.
                </div>
            `;
        }

        function formatReadablePhone(phone) {
            const digits = (phone || '').replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
            }
            return phone || '';
        }

        function createLenderRow(initial = {}) {
            const row = document.createElement('div');
            row.className = 'dcg-lender-row';

            row.innerHTML = `
                <div class="dcg-lender-field">
                    <label>Creditor</label>
                    <input type="text" class="dcg-input" data-field="name" placeholder="e.g. Fundbox" value="${initial.name || ''}">
                </div>
                <div class="dcg-lender-field">
                    <label>Current balance</label>
                    <input type="text" class="dcg-input" data-field="balance" placeholder="$75,000" value="${initial.balance || ''}">
                </div>
                <div class="dcg-lender-field">
                    <label>Payment frequency</label>
                    <select class="dcg-select" data-field="frequency">
                        <option value="daily" ${initial.frequency === 'daily' ? 'selected' : ''}>Daily (ACH)</option>
                        <option value="weekly" ${!initial.frequency || initial.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="biweekly" ${initial.frequency === 'biweekly' ? 'selected' : ''}>Biweekly</option>
                        <option value="monthly" ${initial.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                </div>
                <div class="dcg-lender-field">
                    <label>Payment amount</label>
                    <input type="text" class="dcg-input" data-field="amount" placeholder="$2,500" value="${initial.amount || ''}">
                </div>
                <div class="dcg-lender-field">
                    <label>Notes</label>
                    <input type="text" class="dcg-input" data-field="notes" placeholder="Optional (e.g. MCA)">
                </div>
                <button type="button" class="dcg-remove-row" title="Remove lender">Remove</button>
            `;

            row.querySelector('.dcg-remove-row').addEventListener('click', () => {
                if (lenderRowsEl.children.length > 1) {
                    row.remove();
                    markDirty();
                }
            });

            ['input', 'change'].forEach(evt => {
                row.addEventListener(evt, () => markDirty());
            });

            lenderRowsEl.appendChild(row);
        }

        function parseCurrency(value) {
            if (!value) return 0;
            const num = parseFloat(value.toString().replace(/[^0-9.]/g, ''));
            return Number.isFinite(num) ? num : 0;
        }

        function convertToWeekly(amount, frequency) {
            switch (frequency) {
                case 'daily':
                    return amount * 5;
                case 'biweekly':
                    return amount / 2;
                case 'monthly':
                    return amount / 4.33;
                default:
                    return amount;
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(Math.round(value || 0));
        }

        function qualificationMessage(totalBalance, weeklyTarget) {
            if (totalBalance < 25000) {
                if (totalBalance === 0) {
                    return {
                        text: 'Add unsecured balances above $25,000 to preview DCG savings.',
                        warning: true
                    };
                }

                return {
                    text: `This scenario totals ${formatCurrency(totalBalance)}. DCG programs usually start at $25K in unsecured debt, but we can share partner options if you need them.`,
                    warning: true
                };
            }

            if (weeklyTarget < 500) {
                return {
                    text: `Weekly payments could land around ${formatCurrency(weeklyTarget)}. We’ll double-check minimum thresholds with underwriting on your follow-up call.`,
                    warning: false
                };
            }

            return {
                text: 'Great news! You qualify for a savings review. Tap “I’m interested” and we’ll connect you with a specialist to finalize the plan.',
                warning: false
            };
        }

        function calculateMetrics() {
            const rows = Array.from(lenderRowsEl.querySelectorAll('.dcg-lender-row'));

            let totalBalance = 0;
            let totalWeeklyPayments = 0;

            rows.forEach(row => {
                const balance = parseCurrency(row.querySelector('[data-field="balance"]').value);
                const amount = parseCurrency(row.querySelector('[data-field="amount"]').value);
                const frequency = row.querySelector('[data-field="frequency"]').value;

                totalBalance += balance;
                totalWeeklyPayments += convertToWeekly(amount, frequency);
            });

            const weeklyTarget = totalWeeklyPayments * 0.4463;
            const monthlySavings = Math.max((totalWeeklyPayments - weeklyTarget) * 4.33, 0);
            const estimatedSettlement = totalBalance * 0.55;
            const programLengthMonths = totalWeeklyPayments > 0 ? Math.max(18, Math.round((estimatedSettlement / Math.max(weeklyTarget, 1)) * 4)) : 0;

            return { totalBalance, totalWeeklyPayments, weeklyTarget, monthlySavings, estimatedSettlement, programLengthMonths };
        }

        function applyMetrics(metrics) {
            monthlySavingsEl.textContent = formatCurrency(metrics.monthlySavings);
            weeklyTotalEl.textContent = formatCurrency(metrics.totalWeeklyPayments);
            weeklyTargetEl.textContent = formatCurrency(metrics.weeklyTarget);
            settlementEl.textContent = formatCurrency(metrics.estimatedSettlement);
            programLengthEl.textContent = metrics.programLengthMonths ? `${metrics.programLengthMonths} months` : '—';

            const qual = qualificationMessage(metrics.totalBalance, metrics.weeklyTarget);
            qualificationEl.textContent = qual.text;
            qualificationEl.classList.toggle('dcg-warning', qual.warning);
        }

        function updateStatus(message, state = 'info') {
            statusEl.textContent = message;
            statusEl.classList.remove('dcg-status-info', 'dcg-status-dirty');
            statusEl.classList.add(state === 'dirty' ? 'dcg-status-dirty' : 'dcg-status-info');
        }

        function markDirty() {
            if (!hasRun) {
                return;
            }
            if (!isDirty) {
                isDirty = true;
                updateStatus('Inputs updated. Click “Run savings estimate” to refresh.', 'dirty');
                interestButton.disabled = true;
                interestButton.textContent = "I'm interested in these savings";
            }
        }

        function launchConfetti() {
            if (isCompact) {
                return;
            }
            const colors = ['#0F6C72', '#0B3C3E', '#F7B500', '#26C485', '#F87060'];
            for (let i = 0; i < 24; i++) {
                const piece = document.createElement('span');
                piece.className = 'dcg-confetti-piece';
                piece.style.left = Math.random() * 100 + '%';
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = (Math.random() * 0.4) + 's';
                summaryCard.appendChild(piece);
                setTimeout(() => piece.remove(), 1400);
            }
        }

        addRowBtn.addEventListener('click', () => {
            createLenderRow();
            markDirty();
        });

        runButton.addEventListener('click', () => {
            const metrics = calculateMetrics();
            applyMetrics(metrics);
            hasRun = true;
            isDirty = false;
            updateStatus('Estimates updated just now.', 'info');
            summaryWrapper.classList.add('dcg-visible');
            interestButton.disabled = false;
            interestButton.textContent = "I'm interested in these savings";
            launchConfetti();
        });

        interestButton.addEventListener('click', () => {
            if (isCompact && sidebarFrame && sidebarFrame.style.display !== 'block') {
                sidebarFrame.style.display = 'block';
                if (chatToggle) {
                    chatToggle.classList.add('dcg-open');
                }
            }
            try {
                const frame = document.getElementById('dcgAllyFrameSidebar');
                frame.contentWindow.postMessage({ type: 'DCG_INTEREST' }, '*');
                interestButton.textContent = 'Got it! A specialist will reach out';
                interestButton.disabled = true;
            } catch (error) {
                console.warn('Unable to notify assistant', error);
            }
        });

        createLenderRow({ name: 'Creditor 1', balance: '75000', amount: '2500', frequency: 'weekly' });
        createLenderRow({ name: 'Creditor 2', balance: '50000', amount: '1800', frequency: 'daily' });
    </script>
</body>
</html>
